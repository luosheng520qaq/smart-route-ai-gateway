# SmartRoute AI Gateway

[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python](https://img.shields.io/badge/Python-3.10%2B-blue)](https://www.python.org/)
[![React](https://img.shields.io/badge/React-19-cyan)](https://react.dev/)
[![FastAPI](https://img.shields.io/badge/FastAPI-0.109%2B-green)](https://fastapi.tiangolo.com/)

ä¸€ä¸ªç°ä»£åŒ–çš„ã€å…¼å®¹ OpenAI åè®®çš„æ™ºèƒ½è·¯ç”±ç½‘å…³ã€‚å®ƒèƒ½æ ¹æ®ç”¨æˆ·æ„å›¾å¤æ‚åº¦è‡ªåŠ¨åˆ†æµè¯·æ±‚ï¼Œæ”¯æŒå¤šæ¨¡å‹æ•…éšœè½¬ç§»ï¼ˆFailoverï¼‰ï¼Œå¹¶æä¾›ç¾è§‚çš„ Web ç®¡ç†é¢æ¿ã€‚

![Dashboard Preview](docs/dashboard-preview.png)

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§)
- [é¡¹ç›®æ¶æ„](#-é¡¹ç›®æ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#-é…ç½®è¯´æ˜)
- [API æ–‡æ¡£](#-api-æ–‡æ¡£)
- [å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)
- [æŠ€æœ¯æ ˆ](#-æŠ€æœ¯æ ˆ)
- [è´¡çŒ®æŒ‡å—](#-è´¡çŒ®æŒ‡å—)
- [è®¸å¯è¯](#-è®¸å¯è¯)

## âœ¨ æ ¸å¿ƒç‰¹æ€§

*   **âš¡ æ™ºèƒ½åˆ†æµ (Intelligent Routing)**:
    *   **T1 (ç®€å•)**: é—²èŠã€çŸ­é—®ç­” -> è·¯ç”±è‡³ä½æˆæœ¬æ¨¡å‹ã€‚
    *   **T2 (ä¸­ç­‰)**: ä»£ç ç”Ÿæˆã€æ–‡æ¡ˆå†™ä½œ -> è·¯ç”±è‡³ä¸­ç­‰æˆæœ¬æ¨¡å‹ã€‚
    *   **T3 (å¤æ‚)**: æ·±åº¦æ¨ç†ã€å¤æ‚é€»è¾‘ -> è·¯ç”±è‡³å¤æ‚æˆæœ¬æ¨¡å‹ã€‚
    *   æ”¯æŒåŸºäº**å…³é”®è¯**çš„å¿«é€ŸåŒ¹é…æˆ–**LLM æ„å›¾è¯†åˆ«**ï¼ˆä½¿ç”¨å°æ¨¡å‹åˆ†æç”¨æˆ·æ„å›¾ï¼‰ã€‚

*   **ğŸ›¡ï¸ é«˜å¯ç”¨ä¸å®¹é”™ (High Availability)**:
    *   **æ™ºèƒ½å¥åº·æ£€æŸ¥**: å¼•å…¥**æ—¶é—´è¡°å‡ä¸åŠ¨æ€æƒ©ç½šæœºåˆ¶**ï¼Œæ¨¡å‹é”™è¯¯åˆ†å€¼ä¼šéšæ—¶é—´è‡ªåŠ¨æ¢å¤ï¼Œå¶å‘é”™è¯¯ä¸ä¼šå¯¼è‡´æ¨¡å‹æ°¸ä¹…è¢« banã€‚
    *   **è‡ªåŠ¨æ•…éšœè½¬ç§»**: å½“ä¸»æ¨¡å‹è¿”å› 4xx/5xx é”™è¯¯æˆ–è¶…æ—¶ï¼Œè‡ªåŠ¨æ— ç¼åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹ã€‚
    *   **å…³é”®è¯é‡è¯•**: å³ä½¿çŠ¶æ€ç ä¸º 200ï¼Œè‹¥è¿”å›å†…å®¹åŒ…å« "rate limit", "overloaded" ç­‰å…³é”®è¯ï¼Œä¹Ÿä¼šè‡ªåŠ¨é‡è¯•ã€‚
    *   **å‚æ•°è‡ªé€‚åº”**: æ”¯æŒä¸ºä¸åŒæ¨¡å‹é…ç½®ç‰¹å®šçš„é»˜è®¤å‚æ•°ï¼ˆå¦‚ Kimi å¼ºåˆ¶ `top_p=0.95`ï¼‰ï¼Œè§£å†³ä¸Šæ¸¸å…¼å®¹æ€§é—®é¢˜ã€‚

*   **ğŸ”’ ä¼ä¸šçº§å®‰å…¨ (Enterprise Security)**:
    *   **JWT è®¤è¯**: ç®¡ç†åå°å…¨ç«™é‡‡ç”¨ JWT ä»¤ç‰Œè®¤è¯ï¼Œæ”¯æŒä¼šè¯ç®¡ç†ã€‚
    *   **2FA åŒé‡éªŒè¯**: æ”¯æŒ Google Authenticator / TOTP åŠ¨æ€éªŒè¯ç ï¼Œä¿æŠ¤åå°å®‰å…¨ã€‚
    *   **è®¿é—®æ§åˆ¶**: ç»†ç²’åº¦çš„ Gateway API Key æ§åˆ¶ï¼Œç¡®ä¿ API è°ƒç”¨å®‰å…¨ã€‚

*   **ğŸ“Š å¯è§†åŒ–ç®¡ç†é¢æ¿**:
    *   **å®æ—¶ç›‘æ§**: QPSã€å¹³å‡å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒã€‚
    *   **æ—¥å¿—å®¡è®¡**: å®Œæ•´è®°å½•è¯·æ±‚/å“åº”ä½“ï¼ˆJSONï¼‰ï¼Œæ”¯æŒæµå¼å“åº”é‡ç»„è®°å½•ã€‚
    *   **åœ¨çº¿é…ç½®**: éšæ—¶è°ƒæ•´æ¨¡å‹åˆ—è¡¨ã€è¶…æ—¶æ—¶é—´ã€è·¯ç”±ç­–ç•¥ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚

*   **ğŸ”Œ å…¼å®¹æ€§**:
    *   å®Œå…¨å…¼å®¹ OpenAI `/v1/chat/completions` åè®®ã€‚
    *   æ”¯æŒæµå¼ï¼ˆStreamï¼‰ä¸éæµå¼å“åº”ã€‚
    *   æ”¯æŒè‡ªå®šä¹‰ç½‘å…³é‰´æƒï¼ˆGateway API Keyï¼‰ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
openai_router/
â”œâ”€â”€ backend/                 # Python åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ main.py             # FastAPI ä¸»åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ router_engine.py    # æ ¸å¿ƒè·¯ç”±å¼•æ“ï¼ˆåˆ†æµã€é‡è¯•ã€å¥åº·æ£€æŸ¥ï¼‰
â”‚   â”œâ”€â”€ config_manager.py   # é…ç½®ç®¡ç†å™¨
â”‚   â”œâ”€â”€ database.py         # SQLAlchemy æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ auth.py             # JWTã€2FAã€å¯†ç å®‰å…¨
â”‚   â”œâ”€â”€ logger.py           # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ config.json         # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ logs.db             # SQLite æ•°æ®åº“
â”‚   â””â”€â”€ requirements.txt    # Python ä¾èµ–
â”œâ”€â”€ frontend/                # React å‰ç«¯ç®¡ç†é¢æ¿
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/     # UI ç»„ä»¶ï¼ˆDashboardã€é…ç½®ã€æ—¥å¿—ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ lib/            # API è°ƒç”¨ã€å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ App.tsx         # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ dist/               # æ„å»ºäº§ç‰©
â”‚   â””â”€â”€ package.json        # Node ä¾èµ–
â”œâ”€â”€ start.bat                # Windows å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start.sh                 # Linux/Mac å¯åŠ¨è„šæœ¬
â””â”€â”€ install.sh               # Linux ä¸€é”®å®‰è£…è„šæœ¬
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

| æ¨¡å— | èŒè´£ |
|------|------|
| **Router Engine** | è¯·æ±‚åˆ†æµã€æ•…éšœè½¬ç§»ã€æ¨¡å‹çŠ¶æ€ç®¡ç†ã€æµå¼å“åº”ä»£ç† |
| **Config Manager** | é…ç½®åŠ è½½/ä¿å­˜ã€ç‰ˆæœ¬è¿ç§»ã€çƒ­æ›´æ–° |
| **Database** | è¯·æ±‚æ—¥å¿—ã€æ¯æ—¥ç»Ÿè®¡ã€é…ç½®å†å²ã€ç”¨æˆ·è´¦æˆ· |
| **Auth** | JWT ä»¤ç‰Œã€TOTP 2FAã€å¯†ç å“ˆå¸Œ |

## âš™ï¸ é…ç½®è¯´æ˜

### æ¨¡å‹åˆ†çº§é…ç½® (T1/T2/T3)

åœ¨ [backend/config.json](file:///f:/AstrBotPlugin/openai_router/backend/config.json) ä¸­é…ç½®ï¼š

```json
{
  "models": {
    "t1": [{"model": "gpt-4o-mini", "provider": "upstream"}],
    "t2": [{"model": "gpt-4", "provider": "upstream"}],
    "t3": [{"model": "claude-3-opus", "provider": "custom"}]
  }
}
```

- **T1**: ç®€å•é—®ç­”ã€é—²èŠï¼Œè¿½æ±‚é€Ÿåº¦å’Œä½æˆæœ¬
- **T2**: ä»£ç ç”Ÿæˆã€åˆ›æ„å†™ä½œï¼Œè¿½æ±‚å¹³è¡¡
- **T3**: æ·±åº¦æ¨ç†ã€å¤æ‚ä»»åŠ¡ï¼Œè¿½æ±‚æœ€é«˜è´¨é‡

### å¤šæä¾›å•†é…ç½®

æ”¯æŒé…ç½®å¤šä¸ªä¸Šæ¸¸ API æä¾›å•†ï¼š

```json
{
  "providers": {
    "upstream": {
      "base_url": "https://api.openai.com/v1",
      "api_key": "sk-xxx",
      "protocol": "openai"
    },
    "custom": {
      "base_url": "https://api.anthropic.com/v1",
      "api_key": "sk-ant-xxx",
      "protocol": "openai"
    }
  }
}
```

### æ™ºèƒ½è·¯ç”±é…ç½®

å¯ç”¨ LLM æ„å›¾è¯†åˆ«ï¼ˆä½¿ç”¨å°æ¨¡å‹åˆ†æç”¨æˆ·è¯·æ±‚å¤æ‚åº¦ï¼‰ï¼š

```json
{
  "router": {
    "enabled": true,
    "model": "gpt-4o-mini",
    "base_url": "https://api.openai.com/v1",
    "api_key": "sk-xxx",
    "prompt_template": "..."
  }
}
```

### å¥åº·æ£€æŸ¥ä¸é‡è¯•

```json
{
  "health": {
    "decay_rate": 0.05
  },
  "retries": {
    "max_retries": {"t1": 3, "t2": 3, "t3": 3},
    "conditions": {
      "status_codes": [429, 500, 502, 503, 504],
      "error_keywords": ["rate limit", "overloaded"]
    }
  }
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¿«é€Ÿå®‰è£…

#### Windows
åŒå‡»è¿è¡Œç›®å½•ä¸‹çš„ `start.bat` å³å¯è‡ªåŠ¨å®Œæˆç¯å¢ƒé…ç½®ä¸å¯åŠ¨ã€‚

#### Linux / macOS
æˆ‘ä»¬æä¾›äº†ä¸€é”®å®‰è£…è„šæœ¬ï¼Œè‡ªåŠ¨å¤„ç†ç¯å¢ƒä¾èµ–ã€æ„å»ºä¸å¯åŠ¨ã€‚

æ¨èä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå¿«é€Ÿå®‰è£…ï¼ˆåªéœ€ä¸€è¡Œï¼‰ï¼š

```bash
bash <(curl -sL https://raw.githubusercontent.com/luosheng520qaq/smart-route-ai-gateway/main/install.sh)
```

è¯¥å‘½ä»¤ä¼šè‡ªåŠ¨ï¼š
1. æ£€æŸ¥å¹¶å®‰è£… Git (å¦‚æœéœ€è¦)ã€‚
2. å…‹éš†é¡¹ç›®ä»£ç ã€‚
3. åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–ã€‚
4. è‡ªåŠ¨ç”Ÿæˆå¯åŠ¨è„šæœ¬ã€‚

å®‰è£…å®Œæˆåï¼Œè„šæœ¬ä¼šæç¤ºä½ å¦‚ä½•å¯åŠ¨æœåŠ¡ã€‚

### 2. æ‰‹åŠ¨éƒ¨ç½² (å¦‚æœä¸ä½¿ç”¨è„šæœ¬)

```bash
cd backend
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
# æ¿€æ´»ç¯å¢ƒ (Windows)
venv\Scripts\activate
# æ¿€æ´»ç¯å¢ƒ (Linux/Mac)
source venv/bin/activate

# å®‰è£…ä¾èµ– (æ³¨æ„ï¼šåŒ…å«å®‰å…¨ç»„ä»¶)
pip install -r requirements.txt
```

### 3. å‰ç«¯æ„å»º

```bash
cd frontend
npm install
npm run build
```
æ„å»ºäº§ç‰©ä¼šè‡ªåŠ¨ç”Ÿæˆåˆ° `frontend/dist`ï¼Œåç«¯å°†è‡ªåŠ¨æ‰˜ç®¡ã€‚

### 4. å¯åŠ¨æœåŠ¡

```bash
cd backend
python main.py
```
æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ `http://0.0.0.0:6688`ã€‚

## ğŸ” é»˜è®¤è´¦å·ä¸å®‰å…¨

ç³»ç»Ÿé‡‡ç”¨**é¦–æ¬¡ç™»å½•æ³¨å†Œåˆ¶**ï¼Œæ²¡æœ‰é¢„è®¾å¯†ç ã€‚

1. **é»˜è®¤è´¦å·**: `admin`
2. **é»˜è®¤å¯†ç **: **é¦–æ¬¡ç™»å½•æ—¶è¾“å…¥çš„ä»»æ„å¯†ç **ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶æ³¨å†Œä¸ºæ°¸ä¹…å¯†ç ï¼‰ã€‚
3. **å¼ºçƒˆå»ºè®®**: é¦–æ¬¡ç™»å½•åï¼Œè¯·ç«‹å³å‰å¾€ **ç³»ç»Ÿé…ç½® -> å®‰å…¨è®¾ç½®** å¼€å¯ **2FA åŒé‡éªŒè¯**ã€‚

## ğŸ“ API æ–‡æ¡£

*   **OpenAI ä»£ç†æ¥å£**: `POST /v1/chat/completions`
    *   è®¤è¯: `Authorization: Bearer <Gateway-API-Key>` (å¦‚æœåœ¨è®¾ç½®ä¸­é…ç½®äº† Key)
*   **ç®¡ç†åå° API**: `/api/*`
    *   è®¤è¯: `Authorization: Bearer <JWT-Token>` (é€šè¿‡ç™»å½•è·å–)

## ğŸ”„ æ—§ç‰ˆæœ¬å‡çº§æŒ‡å—

å¦‚æœæ‚¨æ˜¯ä»æ—§ç‰ˆæœ¬å‡çº§ï¼š

1. **å¤‡ä»½æ•°æ®**: å¤‡ä»½ `backend/logs.db` å’Œ `backend/config.json` (å¯é€‰)ã€‚
2. **æ›´æ–°ä»£ç **: è¦†ç›– `backend/` å’Œ `frontend/dist/`ã€‚
3. **æ›´æ–°ä¾èµ–**: åŠ¡å¿…è¿è¡Œ `pip install -r backend/requirements.txt` ä»¥å®‰è£… `passlib`, `python-jose`, `pyotp` ç­‰æ–°ä¾èµ–ã€‚
4. **é‡å¯æœåŠ¡**: æ•°æ®åº“ä¼šè‡ªåŠ¨è¿ç§»ï¼Œæ·»åŠ ç”¨æˆ·è¡¨ã€‚

## â“ å¸¸è§é—®é¢˜ (FAQ)

### Q: å¦‚ä½•ä¿®æ”¹æœåŠ¡ç«¯å£ï¼Ÿ
A: ç¼–è¾‘ [backend/main.py](file:///f:/AstrBotPlugin/openai_router/backend/main.py)ï¼Œä¿®æ”¹ uvicorn è¿è¡Œçš„ç«¯å£ã€‚

### Q: å¦‚ä½•è®¾ç½® Gateway API Key ä¿æŠ¤æˆ‘çš„ä»£ç†ï¼Ÿ
A: åœ¨ Web ç®¡ç†é¢æ¿çš„ **ç³»ç»Ÿé…ç½® -&gt; é€šç”¨è®¾ç½®** ä¸­ï¼Œé…ç½® `gateway_api_key`ã€‚ä¹‹åæ‰€æœ‰ `/v1/chat/completions` è¯·æ±‚éƒ½éœ€è¦åœ¨ Header ä¸­æºå¸¦ `Authorization: Bearer &lt;key&gt;`ã€‚

### Q: ä¸ºä»€ä¹ˆæ¨¡å‹è¢«è‡ªåŠ¨é™çº§äº†ï¼Ÿ
A: å½“æ¨¡å‹è¿ç»­å‡ºé”™æ—¶ï¼Œå¥åº·æ£€æŸ¥æœºåˆ¶ä¼šå¢åŠ è¯¥æ¨¡å‹çš„å¤±è´¥åˆ†å€¼ï¼Œè·¯ç”±å¼•æ“ä¼šä¼˜å…ˆé€‰æ‹©åˆ†å€¼æ›´ä½ï¼ˆæ›´å¥åº·ï¼‰çš„æ¨¡å‹ã€‚åˆ†å€¼ä¼šéšæ—¶é—´è‡ªåŠ¨è¡°å‡æ¢å¤ã€‚

### Q: å¦‚ä½•é‡ç½®ç®¡ç†å‘˜å¯†ç ï¼Ÿ
A: åˆ é™¤ `backend/logs.db` ä¸­çš„ç”¨æˆ·è®°å½•ï¼Œæˆ–ç›´æ¥åˆ é™¤æ•°æ®åº“æ–‡ä»¶é‡å¯ï¼ˆä¼šä¸¢å¤±æ—¥å¿—ï¼‰ï¼Œé¦–æ¬¡ç™»å½•æ—¶è¾“å…¥æ–°å¯†ç å³å¯ã€‚

### Q: å‰ç«¯é¡µé¢æ— æ³•è®¿é—®ï¼Ÿ
A: ç¡®ä¿å·²æ„å»ºå‰ç«¯ï¼šè¿›å…¥ `frontend` ç›®å½•æ‰§è¡Œ `npm run build`ï¼Œç”Ÿæˆ `frontend/dist` ç›®å½•ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯
- **FastAPI**: ç°ä»£å¼‚æ­¥ Web æ¡†æ¶
- **SQLAlchemy**: ORM + Async SQLite
- **httpx**: å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
- **pyotp**: TOTP 2FA
- **python-jose**: JWT ä»¤ç‰Œ
- **passlib**: å¯†ç å“ˆå¸Œ

### å‰ç«¯
- **React 19**: UI æ¡†æ¶
- **TypeScript**: ç±»å‹å®‰å…¨
- **Vite**: æ„å»ºå·¥å…·
- **Tailwind CSS**: æ ·å¼æ¡†æ¶
- **shadcn/ui**: UI ç»„ä»¶åº“
- **Recharts**: å›¾è¡¨åº“
- **Axios**: HTTP å®¢æˆ·ç«¯

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ® Issue å’Œ Pull Requestï¼

### å¼€å‘ç¯å¢ƒæ­å»º

```bash
# åç«¯å¼€å‘
cd backend
python -m venv venv
venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/Mac
pip install -r requirements.txt
python main.py

# å‰ç«¯å¼€å‘ (çƒ­é‡è½½)
cd frontend
npm install
npm run dev  # è®¿é—® http://localhost:5173
```

### æäº¤è§„èŒƒ

- åç«¯ä»£ç ä¿®æ”¹åè¯·æµ‹è¯• API åŠŸèƒ½
- å‰ç«¯ä¿®æ”¹åè¯·è¿è¡Œ `npm run build` æ›´æ–° `dist`
- æäº¤ä¿¡æ¯è¯·æ¸…æ™°æè¿°å˜æ›´å†…å®¹

## ğŸ“„ è®¸å¯è¯

MIT License
